const { createClient } = require('@supabase/supabase-js');

// تحميل متغيرات البيئة
require('dotenv').config({ path: '.env.local' });

// إعداد Supabase
const supabaseUrl = 'https://jrtctjgdkvkdrjcbbbaz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpydGN0amdka3ZrZHJqY2JiYmF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzgyMzksImV4cCI6MjA3MTYxNDIzOX0.39DoF_bU7Yp8MuYoDffNab8h8T-FmvI3u4XJTQ0iX1Q';

const supabase = createClient(supabaseUrl, supabaseKey);

// قواعد التصنيف المحسنة
const categorizationRules = {
  'إخبارية': {
    keywords: ['news', 'أخبار', 'إخبار', 'نيوز', 'الأخبار', 'الإخبارية', 'cnn', 'bbc', 'france24', 'euronews', 'aljazeera', 'الجزيرة', 'العربية', 'سكاي نيوز', 'sky news', 'nbc', 'abc', 'cbs', 'fox news', 'reuters', 'associated press', 'ap', 'dw', 'rt', 'russia today', 'press tv', 'trt', 'الحدث', 'الميادين', 'المنار', 'الحرة', 'مونت كارلو', 'monte carlo', 'rfi', 'radio france', 'الغد', 'الشرق', 'الوطن', 'اليوم', 'الآن', 'now', 'live', 'breaking', 'عاجل', 'urgent', 'flash', 'bulletin', 'نشرة', 'تقرير', 'report', 'تحليل', 'analysis'],
    priority: 1
  },
  'رياضية': {
    keywords: ['sport', 'رياضة', 'رياضي', 'كرة', 'football', 'soccer', 'basketball', 'tennis', 'golf', 'olympics', 'fifa', 'uefa', 'premier league', 'la liga', 'serie a', 'bundesliga', 'ligue 1', 'champions league', 'world cup', 'euro', 'الدوري', 'البطولة', 'كأس', 'مباراة', 'match', 'game', 'الرياضية', 'espn', 'eurosport', 'bein sport', 'بي إن سبورت', 'الكأس', 'الرياضة', 'سبورت', 'أولمبياد', 'كرة القدم', 'كرة السلة', 'التنس', 'الجولف', 'السباحة', 'الجري', 'ألعاب القوى', 'الملاكمة', 'المصارعة', 'الجمباز', 'الفروسية'],
    priority: 2
  },
  'أطفال': {
    keywords: ['kids', 'children', 'أطفال', 'طفل', 'كرتون', 'cartoon', 'animation', 'disney', 'nickelodeon', 'cartoon network', 'baby', 'junior', 'براعم', 'طيور الجنة', 'سبيستون', 'spacetoon', 'mbc3', 'الأطفال', 'للأطفال', 'family', 'عائلة', 'عائلي', 'تعليمي للأطفال', 'educational kids', 'baby tv', 'baraem', 'toyor al janah', 'tom and jerry', 'mickey mouse', 'donald duck', 'peppa pig', 'dora', 'spongebob', 'pokemon', 'ben 10', 'teen titans', 'adventure time', 'regular show'],
    priority: 3
  },
  'موسيقية': {
    keywords: ['music', 'موسيقى', 'موسيقي', 'أغاني', 'أغنية', 'song', 'songs', 'radio', 'راديو', 'fm', 'الموسيقى', 'الأغاني', 'مطرب', 'مطربة', 'singer', 'artist', 'band', 'فرقة', 'كليب', 'clip', 'video clip', 'mtv', 'melody', 'ميلودي', 'rotana', 'روتانا', 'الأغنية', 'concert', 'حفل', 'حفلة', 'festival', 'مهرجان', 'jazz', 'rock', 'pop', 'classical', 'كلاسيكي', 'عربي', 'شرقي', 'غربي', 'لبناني', 'مصري', 'خليجي', 'مغربي', 'تونسي', 'جزائري', 'سوري', 'عراقي', 'أردني', 'فلسطيني'],
    priority: 4
  },
  'أفلام': {
    keywords: ['movie', 'movies', 'film', 'films', 'أفلام', 'فيلم', 'سينما', 'cinema', 'hollywood', 'bollywood', 'الأفلام', 'الفيلم', 'السينما', 'السينمائي', 'درامي', 'كوميدي', 'أكشن', 'action', 'drama', 'comedy', 'thriller', 'horror', 'رعب', 'إثارة', 'رومانسي', 'romantic', 'adventure', 'مغامرة', 'sci-fi', 'علمي', 'خيال علمي', 'fantasy', 'خيال', 'animation', 'رسوم متحركة', 'documentary', 'وثائقي', 'biography', 'سيرة ذاتية', 'historical', 'تاريخي', 'war', 'حرب', 'western', 'غربي', 'crime', 'جريمة', 'mystery', 'غموض'],
    priority: 5
  },
  'ترفيهية': {
    keywords: ['entertainment', 'ترفيه', 'ترفيهي', 'مسلسل', 'مسلسلات', 'series', 'tv series', 'show', 'برنامج', 'برامج', 'program', 'programs', 'الترفيه', 'الترفيهي', 'المسلسل', 'المسلسلات', 'البرنامج', 'البرامج', 'تلفزيوني', 'tv show', 'reality', 'واقعي', 'talk show', 'برنامج حواري', 'variety', 'منوعات', 'comedy', 'كوميدي', 'كوميديا', 'drama', 'دراما', 'درامي', 'soap opera', 'أوبرا', 'sitcom', 'مسرحية', 'theater', 'مسرح', 'stand-up', 'كوميديا الوقوف', 'game show', 'برنامج مسابقات', 'quiz', 'مسابقة', 'talent', 'مواهب', 'singing', 'غناء', 'dancing', 'رقص', 'cooking', 'طبخ', 'travel', 'سفر', 'lifestyle', 'أسلوب حياة'],
    priority: 6
  },
  'دينية': {
    keywords: ['religion', 'religious', 'ديني', 'دينية', 'إسلام', 'إسلامي', 'إسلامية', 'islam', 'islamic', 'quran', 'قرآن', 'القرآن', 'الكريم', 'حديث', 'الحديث', 'سنة', 'السنة', 'فقه', 'الفقه', 'شريعة', 'الشريعة', 'الدين', 'الإسلام', 'المسلم', 'المسلمة', 'المسلمين', 'مكة', 'المدينة', 'الحرم', 'الكعبة', 'الحج', 'العمرة', 'الصلاة', 'الزكاة', 'الصوم', 'رمضان', 'عيد', 'الأعياد', 'جمعة', 'الجمعة', 'خطبة', 'الخطبة', 'درس', 'الدرس', 'محاضرة', 'المحاضرة', 'شيخ', 'الشيخ', 'إمام', 'الإمام', 'عالم', 'العالم', 'فضيلة', 'سماحة', 'معالي'],
    priority: 7
  },
  'وثائقية': {
    keywords: ['documentary', 'وثائقي', 'وثائقية', 'الوثائقي', 'الوثائقية', 'وثيقة', 'الوثيقة', 'تاريخ', 'التاريخ', 'تاريخي', 'التاريخي', 'علم', 'العلم', 'علمي', 'العلمي', 'طبيعة', 'الطبيعة', 'طبيعي', 'الطبيعي', 'حيوان', 'الحيوان', 'حيوانات', 'الحيوانات', 'نبات', 'النبات', 'نباتات', 'النباتات', 'بيئة', 'البيئة', 'بيئي', 'البيئي', 'جغرافيا', 'الجغرافيا', 'جغرافي', 'الجغرافي', 'كوكب', 'الكوكب', 'كواكب', 'الكواكب', 'فضاء', 'الفضاء', 'فضائي', 'الفضائي', 'نجم', 'النجم', 'نجوم', 'النجوم', 'قمر', 'القمر', 'أقمار', 'الأقمار', 'شمس', 'الشمس', 'مجرة', 'المجرة', 'مجرات', 'المجرات', 'كون', 'الكون', 'كوني', 'الكوني', 'اكتشاف', 'الاكتشاف', 'اكتشافات', 'الاكتشافات', 'بحث', 'البحث', 'بحوث', 'البحوث', 'دراسة', 'الدراسة', 'دراسات', 'الدراسات', 'تجربة', 'التجربة', 'تجارب', 'التجارب', 'معرفة', 'المعرفة', 'ثقافة', 'الثقافة', 'ثقافي', 'الثقافي', 'حضارة', 'الحضارة', 'حضاري', 'الحضاري', 'تراث', 'التراث', 'تراثي', 'التراثي', 'أثر', 'الأثر', 'آثار', 'الآثار', 'أثري', 'الأثري', 'متحف', 'المتحف', 'متاحف', 'المتاحف', 'معرض', 'المعرض', 'معارض', 'المعارض', 'مكتبة', 'المكتبة', 'مكتبات', 'المكتبات', 'كتاب', 'الكتاب', 'كتب', 'الكتب', 'مؤلف', 'المؤلف', 'مؤلفات', 'المؤلفات', 'كاتب', 'الكاتب', 'كتاب', 'الكتاب', 'مفكر', 'المفكر', 'مفكرون', 'المفكرون', 'فيلسوف', 'الفيلسوف', 'فلاسفة', 'الفلاسفة', 'فلسفة', 'الفلسفة', 'فلسفي', 'الفلسفي'],
    priority: 8
  },
  'تعليمية': {
    keywords: ['education', 'educational', 'تعليم', 'تعليمي', 'تعليمية', 'التعليم', 'التعليمي', 'التعليمية', 'مدرسة', 'المدرسة', 'مدارس', 'المدارس', 'مدرسي', 'المدرسي', 'جامعة', 'الجامعة', 'جامعات', 'الجامعات', 'جامعي', 'الجامعي', 'كلية', 'الكلية', 'كليات', 'الكليات', 'معهد', 'المعهد', 'معاهد', 'المعاهد', 'أكاديمية', 'الأكاديمية', 'أكاديميات', 'الأكاديميات', 'أكاديمي', 'الأكاديمي', 'طالب', 'الطالب', 'طلاب', 'الطلاب', 'طالبة', 'الطالبة', 'طالبات', 'الطالبات', 'تلميذ', 'التلميذ', 'تلاميذ', 'التلاميذ', 'تلميذة', 'التلميذة', 'معلم', 'المعلم', 'معلمة', 'المعلمة', 'معلمون', 'المعلمون', 'أستاذ', 'الأستاذ', 'أساتذة', 'الأساتذة', 'دكتور', 'الدكتور', 'دكاترة', 'الدكاترة', 'بروفيسور', 'البروفيسور', 'محاضر', 'المحاضر', 'محاضرة', 'المحاضرة', 'محاضرات', 'المحاضرات', 'درس', 'الدرس', 'دروس', 'الدروس', 'حصة', 'الحصة', 'حصص', 'الحصص', 'مادة', 'المادة', 'مواد', 'المواد', 'منهج', 'المنهج', 'مناهج', 'المناهج', 'كتاب', 'الكتاب', 'كتب', 'الكتب', 'مقرر', 'المقرر', 'مقررات', 'المقررات', 'امتحان', 'الامتحان', 'امتحانات', 'الامتحانات', 'اختبار', 'الاختبار', 'اختبارات', 'الاختبارات', 'تقييم', 'التقييم', 'تقييمات', 'التقييمات', 'درجة', 'الدرجة', 'درجات', 'الدرجات', 'علامة', 'العلامة', 'علامات', 'العلامات', 'نتيجة', 'النتيجة', 'نتائج', 'النتائج', 'شهادة', 'الشهادة', 'شهادات', 'الشهادات', 'دبلوم', 'الدبلوم', 'بكالوريوس', 'البكالوريوس', 'ماجستير', 'الماجستير', 'دكتوراه', 'الدكتوراه', 'تخرج', 'التخرج', 'خريج', 'الخريج', 'خريجة', 'الخريجة', 'خريجون', 'الخريجون'],
    priority: 9
  },
  'طبخ': {
    keywords: ['cooking', 'cook', 'طبخ', 'طبخة', 'طباخ', 'طباخة', 'الطبخ', 'الطباخ', 'الطباخة', 'مطبخ', 'المطبخ', 'مطابخ', 'المطابخ', 'طعام', 'الطعام', 'أطعمة', 'الأطعمة', 'أكل', 'الأكل', 'وجبة', 'الوجبة', 'وجبات', 'الوجبات', 'إفطار', 'الإفطار', 'غداء', 'الغداء', 'عشاء', 'العشاء', 'وصفة', 'الوصفة', 'وصفات', 'الوصفات', 'مكونات', 'المكونات', 'مكون', 'المكون', 'خضار', 'الخضار', 'خضروات', 'الخضروات', 'فواكه', 'الفواكه', 'فاكهة', 'الفاكهة', 'لحم', 'اللحم', 'لحوم', 'اللحوم', 'دجاج', 'الدجاج', 'سمك', 'السمك', 'أسماك', 'الأسماك', 'خبز', 'الخبز', 'أرز', 'الأرز', 'معكرونة', 'المعكرونة', 'حلويات', 'الحلويات', 'حلوى', 'الحلوى', 'كيك', 'الكيك', 'بسكويت', 'البسكويت', 'شوكولاتة', 'الشوكولاتة', 'آيس كريم', 'الآيس كريم', 'عصير', 'العصير', 'عصائر', 'العصائر', 'مشروب', 'المشروب', 'مشروبات', 'المشروبات', 'قهوة', 'القهوة', 'شاي', 'الشاي', 'ماء', 'الماء', 'مياه', 'المياه', 'ملح', 'الملح', 'سكر', 'السكر', 'زيت', 'الزيت', 'زيوت', 'الزيوت', 'خل', 'الخل', 'ليمون', 'الليمون', 'بصل', 'البصل', 'ثوم', 'الثوم', 'طماطم', 'الطماطم', 'خيار', 'الخيار', 'جزر', 'الجزر', 'بطاطس', 'البطاطس', 'باذنجان', 'الباذنجان', 'كوسا', 'الكوسا', 'فلفل', 'الفلفل', 'بقدونس', 'البقدونس', 'نعناع', 'النعناع', 'ريحان', 'الريحان', 'زعتر', 'الزعتر', 'كمون', 'الكمون', 'فلفل أسود', 'الفلفل الأسود', 'قرفة', 'القرفة', 'هيل', 'الهيل', 'زنجبيل', 'الزنجبيل', 'كركم', 'الكركم', 'بابريكا', 'البابريكا', 'سماق', 'السماق', 'دبس', 'الدبس', 'عسل', 'العسل', 'مربى', 'المربى', 'جبن', 'الجبن', 'أجبان', 'الأجبان', 'زبدة', 'الزبدة', 'كريمة', 'الكريمة', 'لبن', 'اللبن', 'حليب', 'الحليب', 'بيض', 'البيض', 'بيضة', 'البيضة'],
    priority: 10
  },
  'قنوات مغربية': {
    keywords: ['morocco', 'moroccan', 'مغرب', 'مغربي', 'مغربية', 'المغرب', 'المغربي', 'المغربية', 'الرباط', 'الدار البيضاء', 'كازابلانكا', 'فاس', 'مراكش', 'طنجة', 'أكادير', 'وجدة', 'تطوان', 'الجديدة', 'القنيطرة', 'سلا', 'تمارة', 'المحمدية', 'خريبكة', 'بني ملال', 'الناظور', 'تازة', 'سطات', 'برشيد', 'خنيفرة', 'الحسيمة', 'العرائش', 'قلعة السراغنة', 'الرشيدية', 'ورزازات', 'تيزنيت', 'إفران', 'الصويرة', 'الحاجب', 'أزيلال', 'بوجدور', 'العيون', 'الداخلة', 'السمارة', 'طانطان', 'كلميم', 'زاكورة', 'تنغير', 'الفقيه بن صالح', 'سيدي قاسم', 'سيدي سليمان', 'الجرف الأصفر', 'أولاد تايمة', 'سيدي بنور', 'أزمور', 'برشيد', 'بنسليمان', 'المضيق', 'الفنيدق', 'شفشاون', 'وزان', 'القصر الكبير', 'سيدي كاسم', 'مولاي يعقوب', 'إمزورن', 'الحسيمة', 'بني بوعياش', 'الدريوش', 'جرسيف', 'تاونات', 'غفساي', 'صفرو', 'إموزار كندر', 'بولمان', 'أزرو', 'الريش', 'ميدلت', 'الراشدية', 'أرفود', 'الريصاني', 'بودنيب', 'جديدة', 'أولاد عياد', 'قصبة تادلة', 'الفقيه بن صالح', 'أولاد عمران', 'سوق السبت أولاد النمة', 'الغندور', 'أولاد فرج', 'أولاد حسون', 'أولاد زيان', 'أولاد صالح', 'أولاد عبو', 'أولاد سعيد', 'أولاد يحيى لكراير', 'أولاد مبارك', 'أولاد رحمون', 'أولاد جرار', 'أولاد بوزيري', 'أولاد عزوز', 'أولاد بن سباع', 'أولاد حريز', 'أولاد سيدي علي بن حمدوش', 'أولاد سيدي بن داود', 'أولاد عبد الله', 'أولاد إبراهيم', 'أولاد موسى', 'أولاد علي', 'أولاد أحمد', 'أولاد محمد', 'أولاد عمر', 'أولاد يوسف', 'أولاد عيسى', 'أولاد إدريس', 'أولاد الحاج', 'أولاد السي', 'أولاد الشيخ', 'أولاد المولى', 'أولاد الطالب', 'أولاد الفقيه', 'أولاد القاضي', 'أولاد الإمام', 'أولاد المقدم', 'أولاد الشريف', 'أولاد السيد', 'أولاد الحسن', 'أولاد الحسين', 'أولاد العباس', 'أولاد العلي', 'أولاد الكبير', 'أولاد الصغير', 'أولاد الأمين', 'أولاد الصادق', 'أولاد الطاهر', 'أولاد الزاهر', 'أولاد الباهر', 'أولاد الظاهر', 'أولاد الناصر', 'أولاد المنصور', 'أولاد الغالب', 'أولاد القادر', 'أولاد الماجد', 'أولاد الحميد', 'أولاد الرشيد', 'أولاد السعيد', 'أولاد الوليد', 'أولاد الفريد', 'أولاد الجديد', 'أولاد الشهيد', 'أولاد الوحيد', 'أولاد المجيد', 'أولاد الحفيد', 'أولاد الرفيد', 'أولاد الصعيد', 'أولاد البعيد', 'أولاد القريب', 'أولاد الحبيب', 'أولاد الطيب', 'أولاد النجيب', 'أولاد الأديب', 'أولاد الخطيب', 'أولاد الطبيب', 'أولاد الحكيم', 'أولاد الكريم', 'أولاد الرحيم', 'أولاد الحليم', 'أولاد السليم', 'أولاد النعيم', 'أولاد الجميل', 'أولاد الجليل', 'أولاد الخليل', 'أولاد الدليل', 'أولاد القليل', 'أولاد الكثير', 'أولاد الصغير', 'أولاد الكبير', 'أولاد الأمير', 'أولاد الوزير', 'أولاد النذير', 'أولاد البشير', 'أولاد النصير', 'أولاد الخبير', 'أولاد الصبير', 'أولاد الشكور', 'أولاد الغفور', 'أولاد الصبور', 'أولاد الشكور', 'أولاد الحنون', 'أولاد المأمون', 'أولاد الميمون', 'أولاد المكنون', 'أولاد المصون', 'أولاد المضمون', 'أولاد الموزون', 'أولاد المخزون', 'أولاد المحفوظ', 'أولاد الملحوظ', 'أولاد المحظوظ', 'أولاد المحبوب', 'أولاد المرغوب', 'أولاد المطلوب', 'أولاد المكتوب', 'أولاد المنسوب', 'أولاد المحسوب', 'أولاد الموهوب', 'أولاد المسؤول', 'أولاد المقبول', 'أولاد المعقول', 'أولاد المنقول', 'أولاد المحمول', 'أولاد المأكول', 'أولاد المشروب', 'أولاد الملعوب', 'أولاد المركوب', 'أولاد المكتوب', 'أولاد المحبوب', 'أولاد المرغوب', 'أولاد المطلوب', 'أولاد المكتوب', 'أولاد المنسوب', 'أولاد المحسوب', 'أولاد الموهوب', 'أولاد المسؤول', 'أولاد المقبول', 'أولاد المعقول', 'أولاد المنقول', 'أولاد المحمول', 'أولاد المأكول', 'أولاد المشروب', 'أولاد الملعوب', 'أولاد المركوب', 'medi1', 'medi 1', '2m', 'الأولى', 'الثانية', 'الثالثة', 'الرابعة', 'الخامسة', 'السادسة', 'السابعة', 'الثامنة', 'التاسعة', 'العاشرة', 'الحادية عشرة', 'الثانية عشرة', 'الثالثة عشرة', 'الرابعة عشرة', 'الخامسة عشرة', 'السادسة عشرة', 'السابعة عشرة', 'الثامنة عشرة', 'التاسعة عشرة', 'العشرون', 'الحادية والعشرون', 'الثانية والعشرون', 'الثالثة والعشرون', 'الرابعة والعشرون', 'الخامسة والعشرون', 'السادسة والعشرون', 'السابعة والعشرون', 'الثامنة والعشرون', 'التاسعة والعشرون', 'الثلاثون', 'snrt', 'rtm', 'radio maroc', 'راديو المغرب', 'إذاعة المغرب', 'تلفزة المغرب', 'التلفزة المغربية', 'القناة المغربية', 'القنوات المغربية', 'المغربية', 'المغرب', 'مغربي', 'مغربية'],
    priority: 11
  }
};

// دالة للحصول على معرف الفئة
async function getCategoryId(categoryName) {
  const { data, error } = await supabase
    .from('channel_categories')
    .select('id')
    .eq('name_ar', categoryName)
    .single();
  
  if (error) {
    console.error(`خطأ في الحصول على معرف فئة ${categoryName}:`, error.message);
    return null;
  }
  
  return data.id;
}

// دالة لتصنيف قناة واحدة
function categorizeChannel(channelName) {
  const name = channelName.toLowerCase();
  
  // البحث عن أفضل تطابق
  let bestMatch = null;
  let bestScore = 0;
  let bestPriority = 999;
  
  for (const [category, rules] of Object.entries(categorizationRules)) {
    let score = 0;
    
    // حساب النقاط بناءً على الكلمات المفتاحية
    for (const keyword of rules.keywords) {
      if (name.includes(keyword.toLowerCase())) {
        // إعطاء نقاط أكثر للكلمات الأطول والأكثر تحديداً
        score += keyword.length;
      }
    }
    
    // اختيار الفئة بأعلى نقاط، وفي حالة التعادل، الأولوية الأعلى
    if (score > bestScore || (score === bestScore && rules.priority < bestPriority)) {
      bestMatch = category;
      bestScore = score;
      bestPriority = rules.priority;
    }
  }
  
  // إذا لم يتم العثور على تطابق، استخدم "عامة"
  return bestMatch || 'عامة';
}

// دالة لإعادة تصنيف جميع القنوات
async function finalRecategorizeChannels() {
  try {
    console.log('🚀 بدء عملية إعادة التصنيف النهائية...');
    console.log('=' .repeat(60));
    
    // الحصول على جميع القنوات
    const { data: channels, error: channelsError } = await supabase
      .from('channels')
      .select('id, name, category_id');
    
    if (channelsError) {
      console.error('خطأ في الحصول على القنوات:', channelsError.message);
      return;
    }
    
    console.log(`📺 إجمالي القنوات: ${channels.length}`);
    
    // إنشاء خريطة معرفات الفئات
    const categoryIds = {};
    for (const categoryName of Object.keys(categorizationRules)) {
      const id = await getCategoryId(categoryName);
      if (id) {
        categoryIds[categoryName] = id;
      }
    }
    
    console.log(`📋 فئات متاحة: ${Object.keys(categoryIds).length}`);
    console.log('\n🔄 بدء عملية إعادة التصنيف...');
    
    let processedCount = 0;
    let updatedCount = 0;
    let errorCount = 0;
    const categoryStats = {};
    
    // معالجة القنوات في مجموعات
    const batchSize = 50;
    for (let i = 0; i < channels.length; i += batchSize) {
      const batch = channels.slice(i, i + batchSize);
      
      for (const channel of batch) {
        try {
          const suggestedCategory = categorizeChannel(channel.name);
          const newCategoryId = categoryIds[suggestedCategory];
          
          if (newCategoryId && newCategoryId !== channel.category_id) {
            // تحديث فئة القناة
            const { error: updateError } = await supabase
              .from('channels')
              .update({ category_id: newCategoryId })
              .eq('id', channel.id);
            
            if (updateError) {
              console.error(`خطأ في تحديث قناة ${channel.name}:`, updateError.message);
              errorCount++;
            } else {
              updatedCount++;
              categoryStats[suggestedCategory] = (categoryStats[suggestedCategory] || 0) + 1;
            }
          }
          
          processedCount++;
          
          // عرض التقدم كل 100 قناة
          if (processedCount % 100 === 0) {
            console.log(`⏳ تم معالجة ${processedCount}/${channels.length} قناة...`);
          }
          
        } catch (error) {
          console.error(`خطأ في معالجة قناة ${channel.name}:`, error.message);
          errorCount++;
        }
      }
      
      // توقف قصير بين المجموعات
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    console.log('\n🎉 انتهت عملية إعادة التصنيف النهائية!');
    console.log('=' .repeat(60));
    console.log(`📊 إحصائيات العملية:`);
    console.log(`   - قنوات معالجة: ${processedCount}`);
    console.log(`   - قنوات محدثة: ${updatedCount}`);
    console.log(`   - أخطاء: ${errorCount}`);
    
    if (Object.keys(categoryStats).length > 0) {
      console.log('\n📈 توزيع القنوات المحدثة:');
      Object.entries(categoryStats)
        .sort(([,a], [,b]) => b - a)
        .forEach(([category, count]) => {
          console.log(`   - ${category}: ${count} قناة`);
        });
    }
    
  } catch (error) {
    console.error('خطأ عام في إعادة التصنيف:', error.message);
  }
}

// تشغيل السكريبت
if (require.main === module) {
  finalRecategorizeChannels();
}

module.exports = { finalRecategorizeChannels, categorizeChannel };