const { createClient } = require('@supabase/supabase-js')
require('dotenv').config()

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…ÙÙ‚ÙˆØ¯Ø©')
  console.log('SUPABASE_URL:', supabaseUrl ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ Ù…ÙÙ‚ÙˆØ¯')
  console.log('SUPABASE_ANON_KEY:', supabaseKey ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ Ù…ÙÙ‚ÙˆØ¯')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseKey)

async function testAdminLogin() {
  console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†...')
  
  try {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ auth.users
    console.log('\n1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...')
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… service role Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ auth.users
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY
    if (!serviceKey) {
      console.log('âš ï¸  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ auth.users Ø¨Ø¯ÙˆÙ† service role key')
    } else {
      const serviceSupabase = createClient(supabaseUrl, serviceKey)
      const { data: authUsers, error: authError } = await serviceSupabase
        .from('auth.users')
        .select('id, email, created_at')
        .eq('email', 'admin@zomiga.com')
      
      if (authError) {
        console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError.message)
      } else if (authUsers && authUsers.length > 0) {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:')
        console.log('   ID:', authUsers[0].id)
        console.log('   Email:', authUsers[0].email)
        console.log('   Created:', authUsers[0].created_at)
      } else {
        console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©')
      }
    }
    
    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    console.log('\n2ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ...')
    const { data: profiles, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('username', 'admin')
    
    if (profileError) {
      console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:', profileError.message)
    } else if (profiles && profiles.length > 0) {
      console.log('âœ… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…ÙˆØ¬ÙˆØ¯:')
      console.log('   ID:', profiles[0].id)
      console.log('   Username:', profiles[0].username)
      console.log('   Full Name:', profiles[0].full_name)
      console.log('   Role:', profiles[0].role)
      console.log('   Active:', profiles[0].is_active)
    } else {
      console.log('âŒ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')
    }
    
    // 3. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    console.log('\n3ï¸âƒ£ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...')
    const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
      email: 'admin@zomiga.com',
      password: 'Admin123!@#'
    })
    
    if (loginError) {
      console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', loginError.message)
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø®Ø±Ù‰
      console.log('\nğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø®Ø±Ù‰...')
      const { data: loginData2, error: loginError2 } = await supabase.auth.signInWithPassword({
        email: 'admin@zomiga.com',
        password: 'Ab123456'
      })
      
      if (loginError2) {
        console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:', loginError2.message)
      } else {
        console.log('âœ… Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠØ©!')
        console.log('   User ID:', loginData2.user?.id)
        console.log('   Email:', loginData2.user?.email)
      }
    } else {
      console.log('âœ… Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!')
      console.log('   User ID:', loginData.user?.id)
      console.log('   Email:', loginData.user?.email)
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±
      if (loginData.user) {
        const { data: userProfile, error: userProfileError } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', loginData.user.id)
          .single()
        
        if (userProfileError) {
          console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userProfileError.message)
        } else {
          console.log('   Role:', userProfile?.role || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')
          
          if (userProfile?.role === 'admin') {
            console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†!')
          } else {
            console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†')
          }
        }
      }
    }
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error)
  }
}

testAdminLogin()