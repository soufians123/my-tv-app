require('dotenv').config({ path: '.env.local' })
const { createClient } = require('@supabase/supabase-js')

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…ÙÙ‚ÙˆØ¯Ø©')
  console.log('URL:', supabaseUrl ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯')
  console.log('Service Key:', supabaseServiceKey ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯')
  process.exit(1)
}

// Create admin client with service role key
const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

async function createAuthUser() {
  console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...')
  
  try {
    // First, get the existing profile
    const { data: existingProfile, error: profileError } = await supabaseAdmin
      .from('profiles')
      .select('*')
      .eq('role', 'admin')
      .single()
    
    if (profileError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:', profileError.message)
      return
    }
    
    console.log('ğŸ“‹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:')
    console.log('ID:', existingProfile.id)
    console.log('Role:', existingProfile.role)
    
    // Create user in auth.users with the same ID
    const adminEmail = 'admin@example.com'
    const adminPassword = 'admin123456'
    
    console.log('\nğŸ”‘ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...')
    
    const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.createUser({
      id: existingProfile.id, // Use the same ID from profiles
      email: adminEmail,
      password: adminPassword,
      email_confirm: true, // Auto-confirm email
      user_metadata: {
        role: 'admin'
      }
    })
    
    if (authError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', authError.message)
      
      // If user already exists, try to update
      if (authError.message.includes('already registered')) {
        console.log('\nğŸ”„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«...')
        
        const { data: updateData, error: updateError } = await supabaseAdmin.auth.admin.updateUserById(
          existingProfile.id,
          {
            email: adminEmail,
            password: adminPassword,
            email_confirm: true,
            user_metadata: {
              role: 'admin'
            }
          }
        )
        
        if (updateError) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', updateError.message)
        } else {
          console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!')
          console.log('Email:', updateData.user.email)
        }
      }
    } else {
      console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!')
      console.log('ID:', authUser.user.id)
      console.log('Email:', authUser.user.email)
    }
    
    // Update profile to mark as verified
    const { error: updateProfileError } = await supabaseAdmin
      .from('profiles')
      .update({ 
        is_verified: true,
        username: 'admin'
      })
      .eq('id', existingProfile.id)
    
    if (updateProfileError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:', updateProfileError.message)
    } else {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ')
    }
    
    console.log('\nğŸ‰ ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!')
    console.log('ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', adminEmail)
    console.log('ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', adminPassword)
    console.log('\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error.message)
  }
}

createAuthUser().catch(console.error)